<html lang="en" ng-app="authApp">
<head>
    <title>Вхід</title>
    <link rel="stylesheet" type="text/css" href="../styles/style.css">
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.3/angular.min.js"></script>

<div class="container" ng-controller="ctrl">
    <form name="auth" ng-submit="submitMyForm()">
        <div>
            <p style="background-color: rgba(148, 169, 125, 0.34) ">Вхід</p>
        </div>
        <p><label for="useremail">E-mail </label>
            <input id="useremail" name="useremail" type="email" ng-model="fields.useremail"/></p>

        <p><label for="password">Пароль </label>
            <input id="password" name="password" type="password" ng-model="fields.password"/></p>

        <p><label>Увійти як адміністратор
            <input ng-model="check.admin" class="checkbox" value="false" type="checkbox"
                   ng-init="check.admin=false"/></label></p>

        <button class="submit" type="submit"> Увійти</button>
    </form>
</div>
</body>
<script>
    var app = angular.module('authApp', []);
    app.controller('ctrl', function ($scope, $http, $window, $cookies ) {
        $scope.submitMyForm = function () {
            var url;
            var checkbox = $scope.check.admin;
            if (checkbox) {
                url = "http://0.0.0.0:4567/auth/adm";
            } else url = "http://0.0.0.0:4567/auth";

            var data = angular.toJson($scope.fields);

            $http({
                method: "POST",
                url: url,
                dataType: 'json',
                data: data
            }).then(function success(response) {

                var res = response.data.toString();

                if (url.indexOf('adm') !== -1) {
                    if (res.indexOf('UnauthorizedException') !== -1)
                        alert("admin Неправильний email або пароль!");
                    else if (res.indexOf('NotAdminException') !== -1)
                        alert("Ви не адміністратор!");
                    else {
                        addCookies(response.headers('Authorization'));
                        $window.location.href = '/html/admin/home.html';
                    }
                } else {
                    if (res.indexOf('UnauthorizedException') !== -1)
                        alert("Неправильний email або пароль!");
                    else {
                        addCookies(response.headers('Authorization'));
                        $window.location.href = '/html/home.html';
                    }
                }
            }, function exception(response) {
                console.log("ERROR = " + response.statusText);
                alert("Промилка серверу, обновіть сторінку і спробуйте ще раз!");
            });
        };
        function addCookies(token) {
            //set cookie
            $cookies.put('token', token);
            //get cookie
            //var token = $cookies.get('token');
            //remove token
            //$cookies.remove('token');

           // $window.sessionStorage.setItem('userInfo-token', token);
        }
        //addCookies.$inject=['$cookies'];
    });
</script>
</html>